# If the AddEncoding directives above are commented-out, then you
# probably should define those extensions to indicate media types:
#
AddType application/x-compress .Z
AddType application/x-gzip .gz .tgz

#
#   MIME-types for downloading Certificates and CRLs
#
AddType application/x-x509-ca-cert .crt
AddType application/x-pkcs7-crl    .crl

#	for JBrowse
AddType application/octet-stream .bam .bami

#
# AddHandler allows you to map certain file extensions to "handlers":
# actions unrelated to filetype. These can be either built into the server
# or added with the Action directive (see below)
#
# To use CGI scripts outside of ScriptAliased directories:
# (You will also need to add "ExecCGI" to the "Options" directive.)
#
AddHandler cgi-script .cgi

#
# For files that include their own HTTP headers:
#
#AddHandler send-as-is asis

#
# For type maps (negotiated resources):
# (This is enabled by default to allow the Apache "It Worked" page
#  to be distributed in multiple languages.)
#
AddHandler type-map var

#
# Filters allow you to process content before it is sent to the client.
#
# To parse .shtml files for server-side includes (SSI):
# (You will also need to add "Includes" to the "Options" directive.)
#
AddType text/html .shtml
AddOutputFilter INCLUDES .shtml

#
# Listen: Allows you to bind Apache to specific IP addresses and/or
# ports, in addition to the default. See also the <VirtualHost>
# directive.
#
# Change this to Listen on specific IP addresses as shown below to
# prevent Apache from glomming onto all bound IP addresses (0.0.0.0)
#

# ProPortal
Listen 127.0.0.1:4009
# Galaxy
Listen 127.0.0.1:4011
# JBrowse
Listen 127.0.0.1:4012
# ProPortal test server
Listen 127.0.0.1:4013

#
# WebDAV module configuration section.
#
#<IfModule mod_dav_fs.c>
#    # Location of the WebDAV lock database.
#    DAVLockDB /global/homes/w/wwwimg/apache/run/lockdb
#    DAVLockDB /global/homes/a/aireland/apache/run/lockdb
#</IfModule>


# -----------------------------------------------------------------------------------------
#
#	ProPortal dev server plus assets
#
# -----------------------------------------------------------------------------------------
<VirtualHost *:4009>
	ServerName img-proportal-dev.jgi.doe.gov
	ServerAdmin AIreland@lbl.gov
	DocumentRoot /global/homes/w/wwwimg/svn/webUI/
	ScriptAlias /cgi-bin/ %{DOCUMENT_ROOT}proportal/cgi-bin/

	<Directory />
		Options FollowSymLinks Includes
		AllowOverride None
	</Directory>

	# LOGS
	LogLevel info
	ErrorLog ${APACHE_LOGS_DIR}/proportal-dev_error.log
	CustomLog ${APACHE_LOGS_DIR}/proportal-dev_access.log vhost_combined

	Include ${APACHE_DEFAULT_DIR}/file_system/proportal_files.conf
	Include ${APACHE_DEFAULT_DIR}/file_system/img_files.conf
	Include ${APACHE_DEFAULT_DIR}/file_system/jbrowse_files.conf

	ErrorDocument 403 /403
	ErrorDocument 404 /404
	ErrorDocument 500 /500.shtml
	ErrorDocument 503 /503.shtml

	ProxyRequests off
	RewriteEngine On

#	RewriteLog ${APACHE_LOGS_DIR}/proportal-dev-rewrite.log
#	RewriteLogLevel 3

#	Galaxy redirect
RewriteRule ^/galaxy(.*)$ https://img-galaxy-test.jgi.doe.gov/$1 [L]

# IMG resources
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} ^/(assets|css|images|js|bower)/(.*)$
RewriteCond %{DOCUMENT_ROOT}/proportal/public/%1/%2 -f
RewriteRule . %{DOCUMENT_ROOT}/proportal/public/%1/%2 [L]

# IMG css/js/images
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} ^/(.*/)?(css|images|js)/(.*)$
RewriteCond %{DOCUMENT_ROOT}/%2/%3 -f
RewriteRule . %{DOCUMENT_ROOT}/%2/%3 [L]

# Common IMG redirects
RewriteRule ^/(docs|yui|yui270|yui282|yui290)(/.*) /global/homes/w/wwwimg/apache/content/vhosts/img.jgi.doe.gov/htdocs/$1$2 [L]

#	Plack debugger
RewriteRule ^/(debug_toolbar/.*) /global/homes/a/aireland/perl5/lib/perl5/auto/share/dist/Plack-Middleware-Debug/$1 [L]

#	Redirect all to offline
#RewriteRule . http://localhost:5009/offline [L,P]

# main page redirect
RewriteCond %{REQUEST_URI} =/cgi-bin/main.cgi
RewriteCond %{QUERY_STRING} ^$
RewriteCond %{REQUEST_METHOD} =GET
RewriteRule ^ http://localhost:5009/ [L,P]

# taxon / gene / scaffold details
#m!page=(gene|taxon|scaffold)detail&section=(gene|taxon|scaffold)detail&(gene|taxon|scaffold)_oid=(\d+)$!i
RewriteCond %{REQUEST_URI} =/cgi-bin/main.cgi
RewriteCond &%{QUERY_STRING} (?:^|&)page=(taxon|gene|scaffold)detail [NC]
RewriteCond %1!&%{QUERY_STRING} (?:^|&)section=%1detail [NC]
RewriteCond %1!&%{QUERY_STRING} (?:^|&)%1_oid=(\d+) [NC]

RewriteRule ^/cgi-bin/main.cgi /details/%{TYPE}e/%{OID} [R,L]

# RewriteRule ^index\.php$ http://store.example.com/%1/%2/? [R,L]



#RewriteRule ^/taxon/.* http://localhost:5009/offline [L,P]
#RewriteRule ^//?taxon/(\d+)$ /cgi-bin/main.cgi?section=TaxonDetail&page=taxonDetail&taxon_oid=$1

# standard IMG stuff
RewriteRule ^/(cgi-bin/.*) %{DOCUMENT_ROOT}/proportal/$1 [L]

#	JBrowse on img-proportal-dev
RewriteRule ^/jbrowse_assets/data_dir/(.*) /webfs/scratch/img/Transcriptomics/$1 [L]
RewriteRule ^/jbrowse_assets/(.*) /webfs/projectdirs/microbial/img/jbrowse/$1 [L]
#	temp hack
RewriteRule ^/jbrowse/jbrowse_assets/data_dir/(.*) /global/projectb/scratch/aireland/$1 [L]
RewriteRule ^/jbrowse/jbrowse_assets/(.*) /webfs/projectdirs/microbial/img/jbrowse/$1 [L]
RewriteRule ^/jbrowse/(plugins/.*) /webfs/projectdirs/microbial/img/jbrowse/$1 [L]
RewriteRule ^/jbrowse/(img/.*) /webfs/projectdirs/microbial/img/jbrowse/$1 [L]

RewriteRule ^/node_modules/(.*) %{DOCUMENT_ROOT}/proportal/node_modules/$1 [L]
RewriteRule ^/(.*)(.s?html) %{DOCUMENT_ROOT}/proportal/public/$1$2 [L]

# END OF REWRITE RULES

	# Plack server
	# twiggy
#	ProxyPass /async http://localhost:4010/
#	ProxyPassReverse /async http://localhost:4010/
	# starman
	ProxyPass / http://localhost:5009/
	ProxyPassReverse / http://localhost:5009/

</VirtualHost>

# -----------------------------------------------------------------------------------------
#
# GALAXY TEST SERVER
#
# -----------------------------------------------------------------------------------------
<VirtualHost *:4011>
	ServerName img-galaxy-test.jgi.doe.gov
	ServerAdmin AIreland@lbl.gov
	DocumentRoot /global/homes/w/wwwimg/svn/webUI/

	# for proportal assets
	Include ${APACHE_DEFAULT_DIR}/file_system/proportal_files.conf

	# LOGS
	LogLevel info
	ErrorLog ${APACHE_LOGS_DIR}/${HOSTNAME}-galaxy_error.log
	CustomLog ${APACHE_LOGS_DIR}/${HOSTNAME}-galaxy_access.log vhost_combined

	<Location "/">
		RequestHeader set X-URL-SCHEME https
		# Compress all uncompressed content.
		SetOutputFilter DEFLATE
		SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary
		SetEnvIfNoCase Request_URI \.(?:t?gz|zip|bz2)$ no-gzip dont-vary
		SetEnvIfNoCase Request_URI /history/export_archive no-gzip dont-vary
	</Location>

	<Location "/static">
		# Allow browsers to cache everything from /static for 6 hours
		ExpiresActive On
		ExpiresDefault "access plus 6 hours"
	</Location>

	RewriteEngine On

	# misdirected URLs from other parts of the site
	RewriteRule ^/galaxy(.*) $1 [L]

	# Galaxy static files
	RewriteRule ^/static/style/(.*) /webfs/projectdirs/microbial/img/external/galaxy/static/style/blue/$1 [L]
	RewriteRule ^/static/scripts/(.*) /webfs/projectdirs/microbial/img/external/galaxy/static/scripts/packed/$1 [L]
	RewriteRule ^/static/(.*) /webfs/projectdirs/microbial/img/external/galaxy/static/$1 [L]
	RewriteRule ^/favicon.ico /webfs/projectdirs/microbial/img/external/galaxy/static/favicon.ico [L]
	RewriteRule ^/robots.txt /webfs/projectdirs/microbial/img/external/galaxy/static/robots.txt [L]
	# ProPortal assets
	RewriteRule ^/(js|css|images)/(.*) %{DOCUMENT_ROOT}/proportal/public/$1/$2 [L]
	RewriteRule ^(.*) http://localhost:5011$1 [P]

</VirtualHost>


# -----------------------------------------------------------------------------------------
#
# JBROWSE TEST SERVER
#
# -----------------------------------------------------------------------------------------
<VirtualHost *:4012>
	ServerName img-jbrowse-test.jgi.doe.gov
	ServerAdmin AIreland@lbl.gov
#	DocumentRoot /webfs/projectdirs/microbial/img/jbrowse/
#
#	# LOGS
#	LogLevel info
#	ErrorLog ${APACHE_LOGS_DIR}/${HOSTNAME}-jbrowse_error.log
#	CustomLog ${APACHE_LOGS_DIR}/${HOSTNAME}-jbrowse_access.log vhost_combined
#
#	Include ${APACHE_DEFAULT_DIR}/file_system/jbrowse_files.conf
#
#	ProxyRequests off
#	RewriteEngine On
#
#	# JBrowse redirects
#	RewriteRule ^/jbrowse_assets/data_dir/(.*) /webfs/scratch/img/Transcriptomics/$1 [L]
#	RewriteRule ^/jbrowse_assets/(.*) /webfs/projectdirs/microbial/img/jbrowse/$1 [L]
##	RewriteRule ^(.*) /webfs/projectdirs/microbial/img/jbrowse$1 [L]
#	RewriteRule ^/(plugins/.*) /webfs/projectdirs/microbial/img/jbrowse/$1 [L]
#	RewriteRule ^/(img/.*) /webfs/projectdirs/microbial/img/jbrowse/$1 [L]
#
#	# JBrowse server?
#	ProxyPass /(\d+) http://localhost:5013/jbrowse/$1
#	ProxyPassReverse /(\d+) http://localhost:5013/jbrowse/$1

	DocumentRoot /global/homes/w/wwwimg/svn/webUI/

	# for proportal assets
	Include ${APACHE_DEFAULT_DIR}/file_system/proportal_files.conf

	# LOGS
	LogLevel info
	ErrorLog ${APACHE_LOGS_DIR}/${HOSTNAME}-galaxy_error.log
	CustomLog ${APACHE_LOGS_DIR}/${HOSTNAME}-galaxy_access.log vhost_combined

	<Location "/">
		RequestHeader set X-URL-SCHEME https
		# Compress all uncompressed content.
		SetOutputFilter DEFLATE
		SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary
		SetEnvIfNoCase Request_URI \.(?:t?gz|zip|bz2)$ no-gzip dont-vary
		SetEnvIfNoCase Request_URI /history/export_archive no-gzip dont-vary
	</Location>

	<Location "/static">
		# Allow browsers to cache everything from /static for 6 hours
		ExpiresActive On
		ExpiresDefault "access plus 6 hours"
	</Location>

	RewriteEngine On

	# misdirected URLs from other parts of the site
	RewriteRule ^/galaxy(.*) $1 [L]

	# Galaxy static files
	RewriteRule ^/static/style/(.*) /webfs/projectdirs/microbial/img/external/galaxy/static/style/blue/$1 [L]
	RewriteRule ^/static/scripts/(.*) /webfs/projectdirs/microbial/img/external/galaxy/static/scripts/packed/$1 [L]
	RewriteRule ^/static/(.*) /webfs/projectdirs/microbial/img/external/galaxy/static/$1 [L]
	RewriteRule ^/favicon.ico /webfs/projectdirs/microbial/img/external/galaxy/static/favicon.ico [L]
	RewriteRule ^/robots.txt /webfs/projectdirs/microbial/img/external/galaxy/static/robots.txt [L]
	# ProPortal assets
	RewriteRule ^/(js|css|images)/(.*) %{DOCUMENT_ROOT}/proportal/public/$1/$2 [L]
	RewriteRule ^(.*) http://localhost:5012$1 [P]

</VirtualHost>

# -----------------------------------------------------------------------------------------
#
# PROPORTAL TEST SERVER
#
# -----------------------------------------------------------------------------------------
<VirtualHost *:4013>
	ServerName img-proportal-test.jgi.doe.gov
	ServerAdmin AIreland@lbl.gov
	DocumentRoot /global/homes/w/wwwimg/svn/webUI/
#	ScriptAlias /cgi-bin/ %{DOCUMENT_ROOT}proportal/cgi-bin/

    # LOGS
	LogLevel info
	ErrorLog ${APACHE_LOGS_DIR}/proportal-test_error.log
	CustomLog ${APACHE_LOGS_DIR}/proportal-test_access.log vhost_combined

	Include ${APACHE_DEFAULT_DIR}/file_system/proportal_files.conf
	Include ${APACHE_DEFAULT_DIR}/file_system/img_files.conf
	Include ${APACHE_DEFAULT_DIR}/file_system/jbrowse_files.conf

	# ERROR DOCS
	ErrorDocument 403 /403
	ErrorDocument 404 /404
	ErrorDocument 500 /500.shtml
	ErrorDocument 503 /503.shtml

	ProxyRequests off
	RewriteEngine On

#	RewriteLog ${APACHE_LOGS_DIR}/proportal-test-rewrite.log
#	RewriteLogLevel 3
#
# Galaxy redirect
RewriteRule ^/galaxy(.*)$ https://img-galaxy-test.jgi.doe.gov$1 [L]

# css stylesheet to be served from /global/homes/a/aireland
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} ^/css/(.*)$
RewriteCond /global/homes/a/aireland/webUI/proportal/public/%1/%2 -f
RewriteRule . /global/homes/a/aireland/webUI/proportal/public/%1/%2 [L]

# IMG resources
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} ^/(assets|css|images|js|bower)/(.*)$
RewriteCond %{DOCUMENT_ROOT}/proportal/public/%1/%2 -f
RewriteRule . %{DOCUMENT_ROOT}/proportal/public/%1/%2 [L]

# IMG css/js/images
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_URI} ^/(.*/)?(css|images|js)/(.*)$
RewriteCond %{DOCUMENT_ROOT}/%2/%3 -f
RewriteRule . %{DOCUMENT_ROOT}/%2/%3 [L]

#	Plack debugger
RewriteRule ^/(debug_toolbar/.*) /global/homes/a/aireland/perl5/lib/perl5/auto/share/dist/Plack-Middleware-Debug/$1 [L]

# IMG resources
RewriteRule ^/(docs|yui|yui270|yui282|yui290)(/.*) /global/homes/w/wwwimg/apache/content/vhosts/img.jgi.doe.gov/htdocs/$1$2 [L]


# main page redirect
RewriteCond %{REQUEST_URI} =/cgi-bin/main.cgi
RewriteCond %{QUERY_STRING} ^$
RewriteCond %{REQUEST_METHOD} =GET
RewriteRule ^ http://localhost:5013/ [L,P]

# IMG stuff - redirect to offline
#RewriteRule ^/taxon/.* http://localhost:5013/offline [L,P]
#RewriteRule ^/cgi-bin/.* http://localhost:5013/offline [L,P]

# taxon details
RewriteRule ^//?taxon/(.*)$ /details/taxon/$1

# standard IMG stuff
# RewriteRule ^/(cgi-bin/.*) %{DOCUMENT_ROOT}/proportal/$1 [L]

#	JBrowse on img-proportal-test
RewriteRule ^/jbrowse_assets/data_dir/(.*) /webfs/scratch/img/Transcriptomics/$1 [L]
RewriteRule ^/jbrowse_assets/(.*) /webfs/projectdirs/microbial/img/jbrowse/$1 [L]

# temp hack
RewriteRule ^/jbrowse/jbrowse_assets/data_dir/(.*) /global/projectb/scratch/aireland/$1 [L]
RewriteRule ^/jbrowse/jbrowse_assets/(.*) /webfs/projectdirs/microbial/img/jbrowse/$1 [L]
RewriteRule ^/jbrowse/(plugins/.*) /webfs/projectdirs/microbial/img/jbrowse/$1 [L]
RewriteRule ^/jbrowse/(img/.*) /webfs/projectdirs/microbial/img/jbrowse/$1 [L]

RewriteRule ^/node_modules/(.*) %{DOCUMENT_ROOT}/proportal/node_modules/$1 [L]
RewriteRule ^/(d3.*) /global/homes/a/aireland/code/$1 [L]
RewriteRule ^/(.*)(.s?html) %{DOCUMENT_ROOT}/proportal/public/$1$2 [L]

# END OF REWRITE RULES

	# Plack server
	# twiggy
#	ProxyPass /async http://localhost:4010/
#	ProxyPassReverse /async http://localhost:4010/
	# starman
	ProxyPass / http://localhost:5013/
	ProxyPassReverse / http://localhost:5013/

</VirtualHost>

