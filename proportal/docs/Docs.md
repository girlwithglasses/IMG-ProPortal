# IMG / ProPortal #

## Controllers and ProPortal Pages ##

Each of the ProPortal queries (clade, ecosystem, data type, etc.) is run by a controller (`ProPortal::Controller::<name>`) that pulls the relevant data, puts it into the appropriate format data structure, and then returns it. Most ProPortal controllers have two methods, `get_data` and `render`; `get_data` pulls the data from the database, and `render` does any data munging, etc., required for output.

## Templates and Template Structure ##

All ProPortal HTML content is stored in template files, held in `proportal/views/`.

Most pages use a template in `views/pages/` with a name that corresponds to the page ID; e.g. the `clade` page (ID `proportal/clade`) uses the template `pages/proportal/clade.tt`. By default, pages use the wrapper `layouts/default.html.tt`, which adds the page header, footer, menus, breadcrumbs, and other shared elements to the page. To specify a different wrapper, set the template variable `page_wrapper` to the appropriate layout.

Reusable page components are stored in `views/inc/`.

## Template Contents ##

Template data is processed by Template Toolkit; the basic template rendering command is

    `process($template_name, \%data, $output, %options);`

Templates are sent query-specific data by the controller, plus a set of common variables and other information that is added before template rendering. This data is collected in a hashref and accessed in the templates using the hash keys, i.e.

```
my %data = (
	no_sidebar => 1,
	current_page => 'proportal/clade',
	results => {
		js => { ... }
	}
);
```

in the templates:

```
<p>The name of this page is [% current_page %].</p>
```

The following data is available in the templates:

| variable name     | data type   | data description |
|-------------------|-------------|------------------|
| `results`         | data struct | query results    |
| `results.js`      | data struct | for those pages where the data should be accessible through JavaScript (e.g. for drawing graphs), using the wrapper `scripts/pageload_wrapper.tt` will dump the data structures in `results.js` and `data_filters` as JSON, available through the function `getJson()`. |

Generated by `AppCore::get_menu_vars`:

| variable name     | data type   | data description |
|-------------------|-------------|------------------|
| `navigation`      | data struct | data structure representing menus |
| `current_page`    | string      | current page ID |
| `no_sidebar`      | boolean     | true if this page has no sidebar (optional) |

Generated by `AppCore::get_tmpl_vars`:

| variable name     | data type   | data description |
|-------------------|-------------|------------------|
| `sw_version`      | string      | ProPortal software version (`$AppCore::VERSION`) |
| `breadcrumbs`     | boolean     | true if breadcrumbs should be shown (optional) |
| `server_name`     | string      | host name |
| `ora_service`     | string      | `$ENV{ORA_SERVICE}` |
| `link`            | function    | generate internal links |
| `ext_link`        | function    | generate external links |

From the query controller:

| variable name     | data type   | data description |
|-------------------|-------------|------------------|
| `tmpl_includes`   | data struct | from controller; page-specific templates to be included |
| `page_wrapper`    | string      | the page wrapper to be used (optional) |

for filtered queries:

| variable name     | data type   | data description |
|-------------------|-------------|------------------|
| `data_filters`    | data struct | filters for this query (optional) |
| `data_filters.active`  | string | currently-active filter |
| `data_filters.all`     | data struct | hashref filter schema |

Automatically added by Dancer2:

| variable name     | data type   | data description |
|-------------------|-------------|------------------|
| `perl_version`    | string      | current version of perl, i.e. `$^V`. |
| `dancer_version`  | string      | current version of Dancer2, i.e. `$Dancer2::VERSION` |
| `settings`        | data struct | hash of the application configuration |
| `session`         | data struct | current session data (if a session exists) |
| `request`         | data struct | current request object |
| `params`          | data struct | hash reference of all the parameters; i.e. `$request->params` |
| `vars`            | data struct | list of request variables, i.e. result of calling the keyword `vars` |
